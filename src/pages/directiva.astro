---
export const prerender = false;

import MainLayout from '../layouts/MainLayout.astro';
import { query } from '../db/connection';

// Emoji flag â†’ ISO code mapping
const EMOJI_TO_CODE: Record<string, string> = {
  'ðŸ‡¦ðŸ‡·': 'ar', 'ðŸ‡¦ðŸ‡¼': 'aw', 'ðŸ‡§ðŸ‡´': 'bo', 'ðŸ‡§ðŸ‡·': 'br', 'ðŸ‡¨ðŸ‡±': 'cl',
  'ðŸ‡¨ðŸ‡´': 'co', 'ðŸ‡¨ðŸ‡·': 'cr', 'ðŸ‡¨ðŸ‡º': 'cu', 'ðŸ‡¨ðŸ‡¼': 'cw', 'ðŸ‡ªðŸ‡¨': 'ec',
  'ðŸ‡¸ðŸ‡»': 'sv', 'ðŸ‡ªðŸ‡¸': 'es', 'ðŸ‡ºðŸ‡¸': 'us', 'ðŸ‡¬ðŸ‡¹': 'gt', 'ðŸ‡­ðŸ‡³': 'hn',
  'ðŸ‡®ðŸ‡¹': 'it', 'ðŸ‡¯ðŸ‡²': 'jm', 'ðŸ‡²ðŸ‡½': 'mx', 'ðŸ‡³ðŸ‡®': 'ni', 'ðŸ‡µðŸ‡¦': 'pa',
  'ðŸ‡µðŸ‡¾': 'py', 'ðŸ‡µðŸ‡ª': 'pe', 'ðŸ‡µðŸ‡·': 'pr', 'ðŸ‡©ðŸ‡´': 'do', 'ðŸ‡¹ðŸ‡¹': 'tt',
  'ðŸ‡ºðŸ‡¾': 'uy', 'ðŸ‡»ðŸ‡ª': 've',
};

const COUNTRY_TO_CODE: Record<string, string> = {
  'argentina': 'ar', 'aruba': 'aw', 'bolivia': 'bo', 'brasil': 'br',
  'chile': 'cl', 'colombia': 'co', 'costa rica': 'cr', 'cuba': 'cu',
  'curazao': 'cw', 'ecuador': 'ec', 'el salvador': 'sv', 'espaÃ±a': 'es',
  'estados unidos': 'us', 'usa': 'us', 'guatemala': 'gt', 'honduras': 'hn',
  'italia': 'it', 'jamaica': 'jm', 'mÃ©xico': 'mx', 'mexico': 'mx',
  'nicaragua': 'ni', 'panamÃ¡': 'pa', 'panama': 'pa', 'paraguay': 'py',
  'perÃº': 'pe', 'peru': 'pe', 'puerto rico': 'pr',
  'repÃºblica dominicana': 'do', 'republica dominicana': 'do',
  'trinidad y tobago': 'tt', 'uruguay': 'uy', 'venezuela': 've',
};

function resolveFlagCode(m: any): string {
  const f = m.country_flag;
  if (f && /^[a-z]{2}$/i.test(f.trim())) return f.trim().toLowerCase();
  if (f && EMOJI_TO_CODE[f]) return EMOJI_TO_CODE[f];
  const c = (m.country || '').toLowerCase().trim();
  return COUNTRY_TO_CODE[c] || '';
}

function getFlagUrl(code: string, width = 40): string {
  if (!code) return '';
  const c = code.trim().toLowerCase();
  if (/^[a-z]{2}$/.test(c)) return `https://flagcdn.com/w${width}/${c}.png`;
  return '';
}

let categories: any[] = [];
let members: any[] = [];

try {
  categories = await query('SELECT * FROM team_categories WHERE is_active = TRUE ORDER BY display_order ASC') as any[];
  members = await query('SELECT * FROM team_members WHERE is_active = TRUE ORDER BY display_order ASC') as any[];
  // Normalize all flags to ISO codes
  members = members.map((m: any) => ({ ...m, _flagCode: resolveFlagCode(m) }));
} catch (e) {
  console.error('Error loading directiva data:', e);
}

// Group members by category
const membersByCategory = categories.map((cat: any) => ({
  ...cat,
  members: members.filter((m: any) => m.category_id === cat.id)
}));
---

<MainLayout title="FEMUNDO - Directiva Organizacional" description="Conoce la directiva de FEMUNDO 2025. Junta directiva, comisiÃ³n ejecutiva, tribunal disciplinario y coordinadores de la FederaciÃ³n Mundial de DominÃ³.">
  <Fragment slot="head">
    <style>
        /* HERO RESPONSIVE */
        .hero-directiva {
            background: var(--gradient);
            color: white;
            padding: 60px 20px;
            text-align: center;
            min-height: 50vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hero-directiva .hero-content h1 {
            font-size: clamp(1.8rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 1rem;
            line-height: 1.2;
            color: white;
        }

        .hero-directiva .hero-content p {
            font-size: clamp(1rem, 2.5vw, 1.3rem);
            margin-bottom: 2rem;
            opacity: 0.95;
        }

        /* NAVEGACIÃ“N RESPONSIVE */
        .nav-quick {
            background: white;
            box-shadow: 0 2px 10px rgba(30, 58, 138, 0.1);
            padding: 10px 15px;
            position: sticky;
            top: 60px;
            z-index: 90;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .nav-quick-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            min-width: max-content;
        }

        .nav-quick a {
            color: var(--primary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
            font-weight: 500;
            font-size: clamp(0.85rem, 2vw, 1rem);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .nav-quick a:hover,
        .nav-quick a.active {
            background: var(--primary);
            color: white;
        }

        /* CONTAINER RESPONSIVE */
        .directiva-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 15px;
        }

        /* SECCIÃ“N RESPONSIVE */
        .seccion-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(30, 58, 138, 0.1);
            margin-bottom: 30px;
            padding: clamp(20px, 4vw, 30px);
            transition: transform 0.3s;
            border-left: 4px solid var(--secondary);
        }

        .seccion-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(30, 58, 138, 0.15);
        }

        .seccion-titulo {
            color: var(--primary-dark);
            font-family: 'Raleway', sans-serif;
            font-weight: 700;
            font-size: clamp(1.4rem, 3vw, 2rem);
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .seccion-titulo i {
            color: var(--secondary);
            font-size: clamp(1.2rem, 2.5vw, 1.6rem);
        }

        /* GRID DE MIEMBROS */
        .miembros-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .miembro-card-dir {
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
            padding: clamp(20px, 4vw, 25px);
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--secondary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            width: 280px;
            max-width: calc(100vw - 3rem);
            flex-shrink: 0;
        }

        .miembro-card-dir::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
        }

        .miembro-card-dir:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(30, 58, 138, 0.15);
            border-color: var(--primary);
        }

        .miembro-foto {
            width: clamp(80px, 15vw, 120px);
            height: clamp(80px, 15vw, 120px);
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 4px solid var(--secondary);
            object-fit: cover;
            transition: all 0.3s ease;
            display: block;
        }

        .miembro-card-dir:hover .miembro-foto {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .miembro-nombre {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-dark);
            font-family: 'Raleway', sans-serif;
        }

        .miembro-cargo {
            font-size: clamp(0.9rem, 2vw, 1rem);
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .miembro-pais {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--gradient);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .miembro-pais-flag {
            width: 24px;
            height: 18px;
            object-fit: cover;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
        }

        .miembro-descripcion {
            font-size: clamp(0.85rem, 1.8vw, 0.95rem);
            color: #666;
            line-height: 1.5;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .ver-mas-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            padding: 0;
            margin-bottom: 15px;
            transition: color 0.3s;
        }

        .ver-mas-btn:hover {
            color: var(--secondary);
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-card {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(30, 58, 138, 0.3);
            padding: 30px;
            text-align: center;
            position: relative;
            animation: modalIn 0.3s ease;
            border: 2px solid var(--secondary);
        }

        .modal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
            border-radius: 20px 20px 0 0;
        }

        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f1f5f9;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            color: #64748b;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #ff4757;
            color: white;
        }

        .modal-foto {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--secondary);
            margin: 0 auto 15px;
        }

        .modal-nombre {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }

        .modal-cargo {
            font-size: 1rem;
            font-weight: 600;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .modal-pais {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--gradient);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .modal-bio {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.7;
            text-align: left;
            margin-bottom: 20px;
        }

        .modal-contacto {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: left;
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
        }

        .modal-contacto a {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-contacto a:hover {
            color: var(--secondary);
        }

        .modal-contacto i {
            width: 20px;
            text-align: center;
            color: var(--secondary);
        }

        .miembro-contacto {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .contacto-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50%;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
        }

        .contacto-btn:hover {
            background: var(--secondary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 140, 0, 0.3);
        }

        .contacto-info {
            font-size: 0.9rem;
            color: #555;
            margin-top: 10px;
        }

        .contacto-info div {
            margin: 2px 0;
        }

        .contacto-info a {
            color: var(--primary);
            text-decoration: none;
        }

        .contacto-info a:hover {
            text-decoration: underline;
        }

        /* MEDIA QUERIES */
        @media (max-width: 768px) {
            .hero-directiva {
                padding: 40px 15px;
                min-height: 40vh;
            }

            .nav-quick {
                padding: 8px 10px;
            }

            .directiva-container {
                padding: 15px 10px;
            }

            .miembros-grid {
                gap: 15px;
            }

            .miembro-card-dir {
                width: 100%;
                max-width: 420px;
            }
        }

        @media (max-width: 480px) {
            .hero-directiva {
                padding: 30px 10px;
            }

            .directiva-container {
                padding: 10px 8px;
            }

            .miembro-card-dir {
                width: 100%;
            }

            .seccion-card {
                margin-bottom: 20px;
                border-radius: 10px;
            }
        }

        /* ACCESIBILIDAD */
        @media (prefers-reduced-motion: reduce) {
            .miembro-card-dir:hover {
                transform: none;
            }
        }

        html {
            scroll-behavior: smooth;
        }

        .nav-quick a:focus,
        .contacto-btn:focus {
            outline: 2px solid var(--secondary);
            outline-offset: 2px;
        }
    </style>
  </Fragment>

    <!-- Hero Section -->
    <section class="hero-directiva">
        <div class="hero-content">
            <h1 data-es="Directiva FEMUNDO 2025" data-en="FEMUNDO Board 2025">Directiva FEMUNDO 2025</h1>
            <p data-es="Conoce a los lÃ­deres que guÃ­an la FederaciÃ³n Mundial de DominÃ³ hacia el futuro" data-en="Meet the leaders who guide the World Domino Federation towards the future">Conoce a los lÃ­deres que guÃ­an la FederaciÃ³n Mundial de DominÃ³ hacia el futuro</p>
        </div>
    </section>

    <!-- Quick Nav -->
    {membersByCategory.length > 0 && (
      <div class="nav-quick">
        <div class="nav-quick-container">
          {membersByCategory.map((cat: any) => (
            <a href={`#cat-${cat.id}`} data-es={cat.name_es} data-en={cat.name_en || cat.name_es}>{cat.name_es}</a>
          ))}
        </div>
      </div>
    )}

    <!-- Main Content -->
    <div class="directiva-container">
      {membersByCategory.map((cat: any) => (
        <section id={`cat-${cat.id}`} class="seccion-card">
          <h2 class="seccion-titulo">
            {cat.icon && <i class={cat.icon}></i>}
            <span data-es={cat.name_es} data-en={cat.name_en || cat.name_es}>{cat.name_es}</span>
          </h2>
          <div class="miembros-grid">
            {cat.members.map((m: any) => (
              <div class="miembro-card-dir">
                <img
                  src={m.photo_url || '/images/directiva/nouser.jpg'}
                  alt={m.full_name}
                  class="miembro-foto"
                  loading="lazy"
                  onerror="this.src='/images/directiva/nouser.jpg'"
                />
                <h3 class="miembro-nombre">{m.full_name}</h3>
                <p class="miembro-cargo" data-es={m.position_es} data-en={m.position_en || m.position_es}>{m.position_es}</p>
                {m.country && (
                  <p class="miembro-pais">
                    {m._flagCode && (
                      <img src={`https://flagcdn.com/w40/${m._flagCode}.png`} alt={m.country} class="miembro-pais-flag" />
                    )}
                    {m.country}
                  </p>
                )}
                {m.bio_es && (
                  <p class="miembro-descripcion" data-es={m.bio_es} data-en={m.bio_en || m.bio_es}>{m.bio_es}</p>
                )}
                <button
                  class="ver-mas-btn"
                  data-member={JSON.stringify({
                    full_name: m.full_name,
                    position_es: m.position_es,
                    position_en: m.position_en || m.position_es,
                    country: m.country,
                    flagCode: m._flagCode,
                    photo_url: m.photo_url || '/images/directiva/nouser.jpg',
                    bio_es: m.bio_es,
                    bio_en: m.bio_en || m.bio_es,
                    email: m.email,
                    phone: m.phone,
                  })}
                  data-es="Ver mÃ¡s"
                  data-en="See more"
                >
                  <i class="fas fa-info-circle"></i> Ver mÃ¡s
                </button>
              </div>
            ))}
          </div>
        </section>
      ))}

      {membersByCategory.length === 0 && (
        <div style="text-align: center; padding: 4rem 1.5rem; color: #94a3b8;">
          <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
          <h3 style="color: #64748b; margin-bottom: 0.5rem;" data-es="Directiva no disponible" data-en="Board not available">Directiva no disponible</h3>
          <p data-es="Pronto publicaremos la informaciÃ³n" data-en="We will publish the information soon">Pronto publicaremos la informaciÃ³n</p>
        </div>
      )}
    </div>

    <!-- MODAL MIEMBRO -->
    <div class="modal-overlay" id="memberModal">
      <div class="modal-card">
        <button class="modal-close" id="modalClose"><i class="fas fa-times"></i></button>
        <img id="modalFoto" src="" alt="" class="modal-foto" />
        <h3 id="modalNombre" class="modal-nombre"></h3>
        <p id="modalCargo" class="modal-cargo"></p>
        <p id="modalPais" class="modal-pais"></p>
        <p id="modalBio" class="modal-bio"></p>
        <div id="modalContacto" class="modal-contacto"></div>
      </div>
    </div>

  <Fragment slot="scripts">
    <script>
        // Smooth scrolling for navigation
        document.querySelectorAll('.nav-quick a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelectorAll('.nav-quick a').forEach(link => link.classList.remove('active'));
                this.classList.add('active');
                const targetId = this.getAttribute('href');
                const targetSection = document.querySelector(targetId);
                if (targetSection) {
                    targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        // Update active navigation based on scroll position
        window.addEventListener('scroll', () => {
            const sections = document.querySelectorAll('.seccion-card');
            const navLinks = document.querySelectorAll('.nav-quick a');

            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (window.scrollY >= sectionTop - 200) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });

        // Add loading effect to images
        document.querySelectorAll('.miembro-foto').forEach(img => {
            img.addEventListener('error', function() {
                this.src = '/images/directiva/nouser.jpg';
            });
        });

        // Add scroll-based animations for cards
        if ('IntersectionObserver' in window) {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.miembro-card-dir').forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(card);
            });
        }

        // MODAL - Ver mÃ¡s
        const modal = document.getElementById('memberModal');
        const modalClose = document.getElementById('modalClose');

        document.querySelectorAll('.ver-mas-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const data = JSON.parse(this.dataset.member);
                document.getElementById('modalFoto').src = data.photo_url;
                document.getElementById('modalFoto').alt = data.full_name;
                document.getElementById('modalNombre').textContent = data.full_name;

                const cargoEl = document.getElementById('modalCargo');
                cargoEl.textContent = data.position_es;
                cargoEl.dataset.es = data.position_es;
                cargoEl.dataset.en = data.position_en;

                const paisEl = document.getElementById('modalPais');
                if (data.country) {
                    let flagHtml = '';
                    if (data.flagCode) {
                        flagHtml = '<img src="https://flagcdn.com/w40/' + data.flagCode + '.png" alt="' + data.country + '" style="width:24px;height:18px;object-fit:cover;border-radius:3px;border:1px solid rgba(255,255,255,0.4);" /> ';
                    }
                    paisEl.innerHTML = flagHtml + data.country;
                    paisEl.style.display = 'inline-flex';
                } else {
                    paisEl.style.display = 'none';
                }

                const bioEl = document.getElementById('modalBio');
                if (data.bio_es) {
                    bioEl.textContent = data.bio_es;
                    bioEl.dataset.es = data.bio_es;
                    bioEl.dataset.en = data.bio_en || data.bio_es;
                    bioEl.style.display = 'block';
                } else {
                    bioEl.style.display = 'none';
                }

                const contactoEl = document.getElementById('modalContacto');
                let contactoHtml = '';
                if (data.email) {
                    contactoHtml += '<a href="mailto:' + data.email + '"><i class="fas fa-envelope"></i> ' + data.email + '</a>';
                }
                if (data.phone) {
                    contactoHtml += '<a href="tel:' + data.phone + '"><i class="fas fa-phone"></i> ' + data.phone + '</a>';
                }
                contactoEl.innerHTML = contactoHtml;
                contactoEl.style.display = contactoHtml ? 'flex' : 'none';

                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        });

        function closeModal() {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        modalClose.addEventListener('click', closeModal);
        modal.addEventListener('click', function(e) {
            if (e.target === modal) closeModal();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.classList.contains('active')) closeModal();
        });
    </script>
  </Fragment>
</MainLayout>
